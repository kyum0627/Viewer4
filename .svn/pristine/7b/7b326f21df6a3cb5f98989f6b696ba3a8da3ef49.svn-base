using IGX.Geometry.DataStructure;
using IGX.Geometry.GeometryBuilder;
using OpenTK.Mathematics;

namespace IGX.ViewControl
{
    public class SelectionOptions
    {
        public bool Enable { get; set; } = true;
        public bool ByPart { get; set; } = true;
        public SelectTo DoWhat { get; set; } = SelectTo.ColorChange;
        public Vector4 Color { get; set; } = new Vector4(1, 0, 0, 1);
        public int Layer { get; set; } = -1;
    }

    public class SelectionManager
    {
        private readonly ModelManager _modelManager;
        public SelectionOptions Selection { get; } = new SelectionOptions();
        public PickHelper Pick { get; } = new PickHelper();
        public List<Vertex> NormalsToDraw { get; set; } = [];
        public List<Matrix4> BoxesToDraw { get; set; } = [];

        private readonly Dictionary<PickedGeometry, (Vector4 Color, SelectTo Mode)> _pickedList = [];
        public Dictionary<PickedGeometry, (Vector4 Color, SelectTo Mode)> PickedItems => _pickedList;
        public void Add(PickedGeometry item, Vector4 color, SelectTo selectMode) => _pickedList[item] = (color, selectMode);
        public bool Remove(PickedGeometry item) => _pickedList.Remove(item);
        public void Clear() => _pickedList.Clear();
        public SelectionManager(ModelManager renderDataManager)
        {
            _modelManager = renderDataManager;
        }

        public void UpdatePickedList(int modelid, List<int> toUpdate)
        {
            bool bExist = Pick.Contains(modelid, toUpdate, PickedItems);

            if (bExist)
            {
                RemovePickedList(modelid, toUpdate, _modelManager);
            }
            else
            {
                AppendPickedList(modelid, toUpdate, _modelManager);
            }
        }

        public void RevertAll()
        {
            _pickedList.Keys.ToList().ForEach(item => RevertBuffer(item.ModelID, item.GeometryID, _modelManager));
            _pickedList.Clear();
        }

        private void RevertBuffer(int mid, int gid, ModelManager modelManager)
        {
            PickedGeometry itemToRemove = new(mid, gid);
            _pickedList.Remove(itemToRemove);
            modelManager.RevertInstanceBuffer(mid, gid);
        }

        private void AppendPickedList(int modelid, List<int> matchingGeometryKeys, ModelManager modelManager)
        {
            matchingGeometryKeys.ForEach(geoKey =>
            {
                PickedGeometry itemToAdd = new(modelid, geoKey);
                if (!_pickedList.ContainsKey(itemToAdd))
                {
                    Vector4 color = Selection.Color;
                    if (Selection.DoWhat == SelectTo.Transparent)
                    {
                        color.W = 0;
                    }

                    _pickedList[itemToAdd] = (color, Selection.DoWhat);
                    modelManager.SetObjectDisplayData(itemToAdd.ModelID, itemToAdd.GeometryID, Selection.DoWhat, color);
                }
            });
        }

        private void RemovePickedList(int? modelid, List<int> matchingGeometryKeys, ModelManager modelManager)
        {
            if (modelid.HasValue)
            {
                matchingGeometryKeys.ForEach(geoKey => RevertBuffer(modelid.Value, geoKey, modelManager));
            }
        }

        public void SelectedObjectsDetails(bool BoxIsOOBB)
        {
            BoxesToDraw.Clear(); NormalsToDraw.Clear();

            foreach (var p in _pickedList)
            {
                if (p.Key.ModelID < 0 || p.Key.ModelID >= _modelManager.Models.Count) continue;

                Matrix4 boxMatrix = BoxIsOOBB
                    ? _modelManager.Models[p.Key.ModelID].Geometries[p.Key.GeometryID].Oobb.ToMatrix()
                    : _modelManager.Models[p.Key.ModelID].Geometries[p.Key.GeometryID].Aabb.ToMatrix();

                if (!BoxIsOOBB && Selection.ByPart)
                {
                    int assyid = _modelManager.Models[p.Key.ModelID].Geometries[p.Key.GeometryID].InstanceData.EassemblyID;
                    boxMatrix = _modelManager.Models[p.Key.ModelID].Eassemblies[assyid].AssemblyAABB.ToMatrix();
                }

                BoxesToDraw.Add(boxMatrix);

                var vectorPosition = _modelManager.Models[p.Key.ModelID].Geometries[p.Key.GeometryID].Oobb.center;
                var vectorNormal = _modelManager.Models[p.Key.ModelID].Geometries[p.Key.GeometryID].Oobb.axisZ;
                if (_modelManager.Models[p.Key.ModelID].Geometries[p.Key.GeometryID].GeometryType == ParaPrimType.FacetVolume)
                {
                    var vol = _modelManager.Models[p.Key.ModelID].Geometries[p.Key.GeometryID] as FacetVolume;
                    vectorPosition = vol.Volume.Surfaces[0].Median.Position;
                    vectorNormal = vol.Volume.Surfaces[0].Median.Normal;
                }

                NormalsToDraw.Add(new Vertex(vectorPosition, vectorNormal));
            }
        }
    }
}