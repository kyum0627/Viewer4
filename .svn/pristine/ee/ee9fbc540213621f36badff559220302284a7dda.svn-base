using IGX.Geometry.DataStructure;
using IGX.Loader;
using IGX.ViewControl;
using IGX.ViewControl.IGX.ViewControl;
using IGX.ViewControl.Render;
using OpenTK.Mathematics;

namespace ViewerTest
{
    public partial class IgxViewer : Form
    {
        private readonly ModelDataLoader modelDataManager = new();
        private readonly IgxViewAPI _api;
        private IgxViewContainer _viewContainer;

        private GLView _mainView;

        private bool _isMultiViewMode = false;

        private IgxViewAPI APIs => _api;
        private AuxillaryDrawSetting Drawing => APIs.Drawing;
        private SelectionOptions Selection => APIs.SelectionManager.Selection;
        private ShaderParameters Shading => APIs.Shading;
        private SceneParameters SceneParameters => APIs.Scene;

        public IgxViewer()
        {
            InitializeComponent();

            _api = new IgxViewAPI();
            _viewContainer = new IgxViewContainer(_api);
            var (glControl1, view1) = _viewContainer.CreateNewView();
            _mainView = view1;

            view1.Dock = DockStyle.Fill;
            splitContainer1.Panel2.Controls.Add(_mainView);
            InitializeViewerSettings();
        }
        private void OpenSecondView()
        {
            // 두 번째 뷰 생성
            var (glc, secondView) = _viewContainer.CreateNewView();

            // 새 Form 생성
            var detailForm = new Form
            {
                Text = "Second View - Detail",
                Size = new System.Drawing.Size(800, 600),
                StartPosition = FormStartPosition.CenterParent
            };

            // 두 번째 뷰를 새 Form에 추가
            detailForm.Controls.Add(secondView);
            secondView.Dock = DockStyle.Fill;  // 전체 채우기

            // 새 Form 열기 (비모달)
            detailForm.Show(this);  // this: 부모 Form

            // 옵션: 새 Form 닫을 때 컨테이너 알림 (RemoveView)
            detailForm.FormClosed += (s, e) =>
            {
                if (_viewContainer.RemoveView(secondView))
                {
                    Console.WriteLine("Second view removed.");
                }
            };
        }
        private void InitializeViewerSettings()
        {
            Drawing.ObjectBox = true;
            Drawing.BackFace = true; // true 이면 뒤면도 그려라
            Drawing.BoxIsOOBB = true;
            Drawing.Coordinates = true;
            Drawing.CompanyLogo = true;

            SceneParameters.CoordinatePosition = CoordinateDrawPosition.LeftDown;
            SceneParameters.VectorSize = 1.0f;
            SceneParameters.VectorColor = new Vector4(1, 0, 1, 0.5f);

            Selection.ByPart = true;
            Selection.Color = new Vector4(1, 0, 0, 1);
            Selection.DoWhat = SelectTo.ColorChange;

            Shading.EdgeThickness = 1f; // 최소 0.5, 최대 3, default = 1
            Shading.EdgeColor = Vector3.Zero;
            Shading.DisplayEdge = true;
            Shading.Mode = ShadeMode.Phong;
        }

        private void LoadAdditionalModels(object sender, EventArgs e)
        {
            LoadNewModelsFromFile();
        }
        private void LoadNewModels(object sender, EventArgs e)
        {
            UnloadModelData();
            LoadNewModelsFromFile();
        }
        private void LoadNewModelsFromFile()
        {
            using OpenFileDialog openFileDialog = new();
            openFileDialog.Filter = "REV and RVM Files|*.rev;*.rvm|All Files|*.*";
            openFileDialog.Multiselect = true;

            if (openFileDialog.ShowDialog() == DialogResult.OK)
            {
                modelDataManager.LoadFiles(openFileDialog.FileNames);
                NewModels(modelDataManager.GetModels());
                UpdateTreeView();
                //RefreshViews();
            }
        }
        public void NewModels(Dictionary<string, Model3D> source)
        {
            APIs.ModelManager.NewModel(source);
            APIs.Scene.TotalBoundingBox = APIs.ModelManager.TotalAabb;
            CameraHelper.InitializeCamera(APIs.Scene.Camera, APIs.Scene.TotalBoundingBox);
        }
        private void UpdateTreeView()
        {
            treeView1.Nodes.Clear();
            TreeViewHelper.InitializeTreeView(treeView1, modelDataManager.GetModels());
        }
        private void UnloadModelData()
        {
            modelDataManager.ClearAll();
            APIs.ModelManager.ClearModels();
            // ClearModelData는 이제 API에서 관리
            APIs.SelectionManager.PickedItems.Clear();
            APIs.SelectionManager.NormalsToDraw.Clear();
            APIs.SelectionManager.BoxesToDraw.Clear();
            APIs.ClipPlanes.Clear();
            treeView1.Nodes.Clear();
        }

        private void UnLoadAll(object sender, EventArgs e)
        {
            UnloadModelData();
        }

        private void drawToolStripMenuItem_Click(object sender, EventArgs e)
        {

        }

        private void subViewToolStripMenuItem_Click(object sender, EventArgs e)
        {
            OpenSecondView();
        }
    }
}
