using IGX.Geometry.Common;
using IGX.Geometry.DataStructure;
using IGX.Geometry.GeometryBuilder;
using IGX.Loader;
using IGX.ViewControl.Render.Materials;
using OpenTK.Mathematics;
using System.Diagnostics;

namespace IGX.ViewControl.Render
{
    public static class RendererDataBuilder
    {
        private static readonly object _lockObject = new();
        public static RendererData Build(int modelId, Model3D model)
        {
            if (model == null)
            {
                throw new ArgumentNullException(nameof(model));
            }
            lock (_lockObject)
            {
                int geometryCount = model.Geometries?.Count ?? 0;
                RendererData renderData = new(modelId);
                AABB3 modelBoundingBox = AABB3.Empty;

                // Model3D 객체의 속성을 직접 사용
                var geometries = model.Geometries;
                var colors = model.IndexedColors;

                if (geometries == null || geometries.Count == 0)
                {
                    Debug.WriteLine($"경고: ID {modelId}인 모델에 지오메트리가 없음.");
                    return renderData;
                }
                try
                {
                    //var test = geometries
                    //    .Where(g => g.Value.GeometryType == ParaPrimType.Cylinder)
                    //    .ToDictionary(g => g.Key, g => g.Value);
                    
                    foreach (var entry in geometries)
                    {
                        (List<Vertex> verticesForGroup, List<uint> faceIndices) = entry.Value.MeshData();

                        uint baseVertex = (uint)renderData.Vertices.Count;
                        uint firstIndex = (uint)renderData.TriIndices.Count;
                        const uint instanceCount = 1u;
                        uint baseInstance = (uint)entry.Value.InstanceData.GeometryID;

                        renderData.AddVertices(verticesForGroup);
                        renderData.AddTriIndices(faceIndices);
                        renderData.AddCommand(new DrawElementsIndirectCommand
                        {
                            count = (uint)faceIndices.Count,
                            instanceCount = instanceCount,
                            firstIndex = firstIndex,
                            baseVertex = baseVertex,
                            baseInstance = baseInstance
                        });

                        Color4 color4 = GetColor4(colors, entry.Value);
                        entry.Value.InstanceData.Color = new Vector4(color4.R, color4.G, color4.B, color4.A);
                        MatColInstance matinst = new MatColInstance();
                        matinst.Color = entry.Value.InstanceData.Color;
                        matinst.Model = entry.Value.InstanceData.Model;
                        renderData.AddInstance(entry.Value.InstanceData, entry.Value.GrandPrimType);
                        modelBoundingBox.Contain(entry.Value.Aabb);
                    }

                    renderData.ModelAabb = modelBoundingBox;
                    return renderData;
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error building render data for model ID {modelId}: {ex.Message}");
                    return renderData;
                }
            }
        }
        private static Color4 GetColor4(Dictionary<uint, VolColor> colors, PrimitiveBase geometry)
        {
            Color4 color = colors.TryGetValue(geometry.ColorID, out VolColor? cv)
                ? cv.ToBuffer()
                : Colors.GetColorValueFromID(geometry.ColorID).ToBuffer();

            color.A = geometry.GrandPrimType switch
            {
                "OBST" => 0.6f, // 투명
                "INSU" => 0.8f,
                _ => 1.0f,
            };

            return color;
        }
    }
}
