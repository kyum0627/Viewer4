using IGX.Geometry.Common;
using IGX.ViewControl.Render;
using OpenTK.GLControl;
using OpenTK.Mathematics;

namespace IGX.ViewControl
{
    public class ViewportController
    {
        private readonly IgxViewAPI _apis;
        private readonly GLControl _glControl;
        private readonly IMyCamera _camera;

        private MouseButtons _mouseButton = MouseButtons.None;
        private Point _prevMousePos = Point.Empty;
        private bool _isMouseDragged;

        public ViewportController(IgxViewAPI apis, GLControl glControl, IMyCamera camera)
        {
            _apis = apis;
            _glControl = glControl;
            _camera = camera;
        }

        public void OnMouseDown(object? sender, MouseEventArgs e)
        {
            _isMouseDragged = false;
            _mouseButton = e.Button;
            _prevMousePos = new Point(MathUtil.Clamp(e.X, 1, _glControl.Width - 1), MathUtil.Clamp(e.Y, 1, _glControl.Height - 1));
        }

        public void OnMouseUp(object? sender, MouseEventArgs e)
        {
            if (_prevMousePos == Point.Empty) return;

            _glControl.MakeCurrent();
            PickHelper.PickUnPick(Control.ModifierKeys, e, _glControl, _apis, _isMouseDragged);

            _mouseButton = MouseButtons.None;
            _prevMousePos = Point.Empty;
            _glControl.Invalidate();
        }

        public void OnMouseMove(object? sender, MouseEventArgs e)
        {
            if (_prevMousePos == Point.Empty) return;

            int currX = MathUtil.Clamp(e.X, 1, _glControl.Width - 1);
            int currY = MathUtil.Clamp(e.Y, 1, _glControl.Height - 1);

            if (_prevMousePos.X == currX && _prevMousePos.Y == currY)
            {
                _isMouseDragged = false;
                return;
            }
            _isMouseDragged = true;

            if (_mouseButton == MouseButtons.Left)
            {
                _camera.Rotate(_prevMousePos.X, _prevMousePos.Y, currX, currY);
            }
            else if (_mouseButton == MouseButtons.Right)
            {
                _camera.Pan(_prevMousePos.X, _prevMousePos.Y, currX, currY);
            }

            _prevMousePos = new Point(currX, currY);
            _glControl.Invalidate();
        }

        public void OnMouseWheel(object? sender, MouseEventArgs e)
        {
            _glControl.MakeCurrent();

            if (e.Delta == 0) return;

            float zoomRatio = e.Delta < 0 ? RendererConstants.ZoomOutRatio : RendererConstants.ZoomInRatio;
            _camera.Zoom(e.X, e.Y, zoomRatio);
            _glControl.Invalidate();
        }

        public void OnMouseLeave(object? sender, EventArgs e)
        {
            _mouseButton = MouseButtons.None;
            _prevMousePos = Point.Empty;
        }
    }
}