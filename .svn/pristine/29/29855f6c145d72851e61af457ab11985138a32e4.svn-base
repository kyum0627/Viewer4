using IGX.Geometry.DataStructure;
using IGX.ViewControl.Render.Materials;
using OpenTK.Graphics.OpenGL4;
using OpenTK.Mathematics;

namespace IGX.ViewControl.Render
{
    public enum CoordinateDrawPosition
    {
        Center,
        LeftDown,
        LeftUp,
        RightDown,
        RightUp
    }
    public class RendererCoordinates
    {
        private readonly RendererInstancedMesh<Vertex, uint, MatColInstance> _coordinates;
        private List<VectorInstance> gizmoData = new List<VectorInstance>
        {
            new VectorInstance(new Vertex(Vector3.Zero, Vector3.UnitX), new Vector4(Vector3.UnitX, 1)),
            new VectorInstance(new Vertex(Vector3.Zero, Vector3.UnitY), new Vector4(Vector3.UnitY, 1)),
            new VectorInstance(new Vertex(Vector3.Zero, Vector3.UnitZ), new Vector4(Vector3.UnitZ, 1))
        };

        private Shader shader;
        public RendererCoordinates(ReadOnlySpan<Vertex> vertices, ReadOnlySpan<uint> indices, ReadOnlySpan<MatColInstance> instances, Shader shader)
        {
            _coordinates = new RendererInstancedMesh<Vertex, uint, MatColInstance>(vertices, indices, instances);
            this.shader = shader;
        }

        public void Draw(IMyCamera camera, CoordinateDrawPosition coordPosition, float arrowsize)
        {
            int[] originalViewport = new int[4];
            GL.GetInteger(GetPName.Viewport, originalViewport);
            GL.Enable(EnableCap.DepthTest);

            var rotate = camera.RotationMatrix;

            int viewportWidth, viewportHeight, viewportX, viewportY;
            Matrix4 gizmoProjection;
            CalculateGizmoProjectionMatrix(camera, coordPosition, out viewportWidth, out viewportHeight, out viewportX, out viewportY, out gizmoProjection);
            
            Matrix4 gizmoView = rotate;
            GL.Viewport(viewportX, viewportY, viewportWidth, viewportHeight);
            DrawCoordinates(gizmoView, gizmoProjection, viewportWidth, viewportHeight, gizmoData, arrowsize);
            GL.Viewport(originalViewport[0], originalViewport[1], originalViewport[2], originalViewport[3]);
        }

        private static void CalculateGizmoProjectionMatrix(IMyCamera camera, CoordinateDrawPosition coordPosition, out int viewportWidth, out int viewportHeight, out int viewportX, out int viewportY, out Matrix4 gizmoProjection)
        {
            var screenWidth = camera.ViewportWidth;
            var screenHeight = camera.ViewportHeight;

            int margin = 20;
            viewportWidth = 100 + margin;
            viewportHeight = 100 + margin;
            switch (coordPosition)
            {
                case CoordinateDrawPosition.Center:
                    viewportX = (screenWidth / 2) - (viewportWidth / 2);
                    viewportY = (screenHeight / 2) - (viewportHeight / 2);
                    break;
                case CoordinateDrawPosition.LeftDown:
                    viewportX = margin;
                    viewportY = margin;
                    break;
                case CoordinateDrawPosition.LeftUp:
                    viewportX = margin;
                    viewportY = screenHeight - viewportHeight - margin;
                    break;
                case CoordinateDrawPosition.RightDown:
                    viewportX = screenWidth - viewportWidth - margin;
                    viewportY = margin;
                    break;
                case CoordinateDrawPosition.RightUp:
                    viewportX = screenWidth - viewportWidth - margin;
                    viewportY = screenHeight - viewportHeight - margin;
                    break;
                default:
                    viewportX = margin;
                    viewportY = margin;
                    break;
            }

            var projectionHalf = (float)Math.Max(viewportWidth, viewportHeight) / 2.0f;
            gizmoProjection = Matrix4.CreateOrthographicOffCenter(-projectionHalf, projectionHalf, -projectionHalf, projectionHalf, -projectionHalf, projectionHalf * 100);
        }

        public void DrawCoordinates(Matrix4 view, Matrix4 projection, int palletWidth, int palletHeight, IEnumerable<VectorInstance> arrowDataList, float size)
        {
            var instanceData = Vector2MatrixInstanceHelper.ConvertVectorToMatrix(arrowDataList, view, projection, palletWidth, size);
            _coordinates.Renderer(view, projection, instanceData, shader, false);
        }
    }
}