using OpenTK.GLControl;
using OpenTK.Windowing.Common;

namespace IGX.ViewControl
{
    namespace IGX.ViewControl
    {
        public class IgxViewContainer : IDisposable
        {
            private readonly IgxViewAPI _apis;
            private readonly List<GLView> _viewManagers = new List<GLView>();
            private bool _isDisposed;
            public IgxViewAPI APIs => _apis;

            public IgxViewContainer(IgxViewAPI paramApi)
            {
                _apis = paramApi ?? throw new ArgumentNullException(nameof(paramApi));
            }
            public (GLControl glControl, GLView viewManager) CreateNewView()
            {
                if (_isDisposed)
                {
                    throw new ObjectDisposedException("IgxViewContainer");
                }

                var glControl = new GLControl(
                     new GLControlSettings()
                     {
                         APIVersion = new Version(4, 6, 0, 0),
                         AutoLoadBindings = true,
                         Flags = ContextFlags.ForwardCompatible,
                         Profile = ContextProfile.Core,
                         IsEventDriven = true,
                         API = ContextAPI.OpenGL,
                         NumberOfSamples = 8,
                         StencilBits = 24,
                         DepthBits = 8,
                         RedBits = 8,
                         GreenBits = 8,
                         BlueBits = 8,
                         AlphaBits = 8,
                         SrgbCapable = true
                     })
                {
                    Dock = DockStyle.Fill,
                    IsEventDriven = true
                };

                var viewManager = new GLView(_apis, glControl);
                _viewManagers.Add(viewManager);
                return (glControl, viewManager);
            }
            public void RefreshAllViews()
            {
                foreach (var viewManager in _viewManagers)
                {
                    viewManager.RefreshControl();
                }
            }

            public void ClearAllViewsData()
            {
                foreach (var viewManager in _viewManagers)
                {
                    viewManager.ClearModelData();
                }
            }

            public void FitModelsInAllViews()
            {
                foreach (var viewManager in _viewManagers)
                {
                    viewManager.FitModel_Click(null, EventArgs.Empty);
                }
            }

            public void Dispose()
            {
                Dispose(true);
                GC.SuppressFinalize(this);
            }

            protected virtual void Dispose(bool disposing)
            {
                if (_isDisposed) return;

                if (disposing)
                {
                    foreach (var viewManager in _viewManagers)
                    {
                        viewManager.Dispose();
                    }
                    _viewManagers.Clear();
                }

                _isDisposed = true;
            }
        }
    }
}