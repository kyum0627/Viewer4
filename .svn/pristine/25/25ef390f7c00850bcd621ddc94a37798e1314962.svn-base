using IGX.Geometry.Common;
using IGX.Geometry.ConvexHull;
using IGX.Geometry.DataStructure;
using IGX.Geometry.DataStructure.IgxMesh;
using IGX.Geometry.GeometryBuilder;
using OpenTK.Mathematics;

namespace IGX.Loader
{
    public interface IModel3D
    {
        Dictionary<int, PrimitiveBase> Geometries { get; set; }
        Dictionary<int, IAssembly> Eassemblies { get; set; }
        Dictionary<uint, VolColor> IndexedColors { get; set; }
    }

    public class Model3D : IModel3D, IEquatable<Model3D>
    {
        public string Filename { get; set; } = string.Empty;
        public AABB3 ModelAABB { get; set; } = AABB3.Empty;
        public Dictionary<int, PrimitiveBase> Geometries { get; set; } = [];
        public Dictionary<int, IAssembly> Eassemblies { get; set; } = [];
        public Dictionary<uint, VolColor> IndexedColors { get; set; } = [];
        public Model3D(string head_name, Dictionary<int, IAssembly> assy, Dictionary<int, PrimitiveBase> geom, Dictionary<uint, VolColor> col, AABB3 box)
        {
            Filename = head_name;
            Eassemblies = assy;
            Geometries = geom;
            IndexedColors = col;
            ModelAABB = box;
        }
        public AABB3 CalculateAssemblyAABB()
        {
            var aabb = AABB3.Empty;
            foreach (var e in Eassemblies)
            {
                AABB3 b = e.Value.AssemblyAABB;
                aabb.Contain(b);
            }
            return aabb;
        }
        public Model3D SetGeometrySelectionMode(int geometryId, SelectTo sm = SelectTo.None)
        {
            if (Geometries.TryGetValue(geometryId, out var primitive))
            {
                primitive.InstanceData.SelectionMode = sm;
            }
            return this;
        }

        public Model3D SetGeometryLayer(int geometryId, int layer)
        {
            if (Geometries.TryGetValue(geometryId, out var primitive))
            {
                primitive.InstanceData.Layer = layer;
            }
            return this;
        }

        public Model3D SetGeometryColor(int geometryId, Vector4 color, bool transparent)
        {
            if (Geometries.TryGetValue(geometryId, out var primitive))
            {
                primitive.InstanceData.Color = color;
            }
            return this;
        }
        public IgxMesh? GetIgxMesh(int geometryId)
        {
            if(GetPrimitiveBase(geometryId) is FacetVolume facetVolume)
            {
                return facetVolume.Volume;
            }
            return null;
        }
        public PrimitiveBase GetPrimitiveBase(int geometryId) => Geometries[geometryId];
        public List<int> GetGeometryIdsOfThePart(int partId) => [.. Geometries.Where(part => part.Value.InstanceData.EassemblyID == partId).Select(part => part.Key)];
        public Vector4 GetGeometryColor(int geometryId) => Geometries.TryGetValue(geometryId, out var primitive) ? primitive.InstanceData.Color : default;
        public int GetGeometryLayer(int geometryId) => Geometries.TryGetValue(geometryId, out var primitive) ? primitive.InstanceData.Layer : -1;
        public GeometryInstance? GetGeometryInstance(int geometryId) => Geometries.TryGetValue(geometryId, out var primitive) ? primitive.InstanceData : null;
        public OOBB3 GetGeometryOOBB(int geometryId) => Geometries.TryGetValue(geometryId, out var primitive) ? primitive.Oobb : OOBB3.Empty;
        public AABB3 GetGeometryAABB(int geometryId) => Geometries.TryGetValue(geometryId, out var primitive) ? primitive.Aabb : AABB3.Empty;
        public int GetAssemblyIndex(int geometryId) => Geometries.TryGetValue(geometryId, out var primitive) ? primitive.InstanceData.EassemblyID : -1;
        public ParaPrimType GetPrimitiveType(int geometryId) => Geometries.TryGetValue(geometryId, out var primitive) ? primitive.GeometryType : default;
        public string? GetGrandPrimitiveType(int geometryId) => Geometries.TryGetValue(geometryId, out var primitive) ? primitive.GrandPrimType : null;
        public float Thickness(int geometryID) => GetIgxMesh(geometryID)?.Thickness ?? -1;

        public bool Equals(Model3D? other)
        {
            if (Filename != other.Filename) return false;
            if (ModelAABB != other.ModelAABB) return false;
            if (Geometries.Count != other.Geometries.Count) return false;
            if (Eassemblies.Count != other.Eassemblies.Count) return false;
            return true;
        }
    }
}