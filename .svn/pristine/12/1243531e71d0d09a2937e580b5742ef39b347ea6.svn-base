using IGX.ViewControl.Buffer;
using IGX.ViewControl.Buffer.Common;
using OpenTK.Graphics.OpenGL4;
using OpenTK.Mathematics;

namespace IGX.ViewControl.Render
{
    public enum RenderMode
    {
        Points,
        Edges,
        Faces
    }
    public class RendererMeshWithEdge<Vtx> : IDisposable where Vtx : struct
    {
        private readonly Shader shader;
        private readonly ElementBuffer<Vtx, uint> buffer;
        private readonly IndexBuffer<uint> edgeRenderer;
        public RendererMeshWithEdge(Vtx[] vertices, uint[] faceIndices, uint[] edgeIndices, Shader shader)
        {
            this.shader = shader;

            buffer = new ElementBuffer<Vtx, uint> ( vertices, faceIndices );
            buffer.Bind();
            edgeRenderer = new IndexBuffer<uint>(edgeIndices, BufferUsageHint.DynamicDraw, true);
            buffer.Unbind();
        }

        public void Render(Matrix4 model, IMyCamera camera, Vector4 color, RenderMode mode)
        {
            shader.Use();
            shader.SetUniformIfExist("uView", camera.ViewMatrix);
            shader.SetUniformIfExist("uProjection", camera.ProjectionMatrix);
            shader.SetUniformIfExist("uObjectColor", color); GLState.ErrorCheck();
            shader.SetUniformIfExist("uModel", model);
            buffer.Bind(); // VBO 및 속성 설정이 담긴 VAO 바인딩
            switch (mode)
            {
                case RenderMode.Points:
                    buffer.Draw(PrimitiveType.Points);
                    break;
                case RenderMode.Edges:
                    edgeRenderer.Draw(PrimitiveType.Lines);
                    buffer.Draw(PrimitiveType.Points);
                    buffer.Draw(PrimitiveType.Triangles);
                    break;
                case RenderMode.Faces:
                    buffer.Draw(PrimitiveType.Triangles);
                    break;
            }
            buffer.Unbind();
        }

        private bool disposedValue = false;

        protected virtual void Dispose(bool disposing)
        {
            if (!disposedValue)
            {
                if (disposing)
                {// 관리되는 리소스(EBO, VBO 등)를 해제.
                    edgeRenderer?.Dispose();
                    shader?.Dispose();
                    buffer?.Dispose();
                }
                disposedValue = true;
            }
        }

        public void Dispose()
        {
            Dispose(true);
            GC.SuppressFinalize(this);
        }
    }
}