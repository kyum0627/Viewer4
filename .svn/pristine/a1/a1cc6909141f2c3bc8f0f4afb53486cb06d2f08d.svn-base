using IGX.Geometry.Common;
using IGX.Geometry.DataStructure;
using IGX.Geometry.GeometryBuilder;

using Newtonsoft.Json;
using IGX.Loader.AMFileLoader;

namespace IGX.Loader
{
    public abstract class ModelLoader
    {
        public FileInformation Header;
        public Dictionary<int, PrimitiveBase> geometries = [];
        public Dictionary<int, IAssembly> assemblies = [];
        public Dictionary<uint, VolColor> colors = [];
        public AABB3 modelBoundingBox = AABB3.Empty;
        //Encoding utf8 = Encoding.GetEncoding("utf-8");

        public static readonly float continuityAngle = (float)Math.Cos(Math.PI / 6);
        public List<string> progress = [];// List<string>();
        public static bool IsFlat(Vertex[] vertices)
        { // 플랫 여부를 확인하는 메서드
            OpenTK.Mathematics.Vector3 baseNormal = vertices[0].Normal;
            foreach (Vertex vertex in vertices)
            {
                if (baseNormal != vertex.Normal)
                {
                    return false;
                }
            }
            return true;
        }

        public static List<(int ID, string Name)> EmptyAssemblies(Dictionary<int, Assembly> assemblies)
        {
            // Geometry가 있는 Assembly만 추림
            Dictionary<int, Assembly> hasGeometry = assemblies
                .Where(a => a.Value.GeometryIDs?.Count > 0)
                .ToDictionary(a => a.Key, a => a.Value);

            // hasGeometry에 있는 항목들의 모든 조상들도 포함해야 하므로
            HashSet<int> extended = new(hasGeometry.Keys);

            foreach (Assembly? assembly in hasGeometry.Values)
            {  // 각 항목에 대해 ParentBomID 체인을 따라 올라가면서 추가
                int parentId = assembly.ParentBomID;
                while (parentId != -1 && assemblies.ContainsKey(parentId))
                {
                    if (!extended.Add(parentId))
                    {
                        break; // 이미 포함된 경우 중지
                    }

                    parentId = assemblies[parentId].ParentBomID;
                }
            }

            // 확장된 hasGeometry에 포함되지 않은 나머지 Assembly들을 추림
            List<(int ID, string Name)> emptyAssemblies = assemblies
                .Where(a => !extended.Contains(a.Key))
                .Select(a => (a.Value.ID, a.Value.Name))
                .ToList();

            return emptyAssemblies;
        }

        public virtual string ToJson()
        {
            JsonSerializerSettings settings = new()
            { // 순환 참조 무시
                Formatting = Formatting.Indented,
                Converters = [new Vector2Converter(), new Vector3Converter(), new Vector4Converter()]
            };
            return JsonConvert.SerializeObject(this, settings);
        }

        public virtual void FromJson(string json)
        {
            JsonConvert.PopulateObject(json, this);
        }
        public virtual void SaveToFile(string filePath)
        {
            string json = ToJson();
            File.WriteAllText(filePath, json);
        }
        public virtual void LoadFromFile(string filePath)
        {
            string json = File.ReadAllText(filePath);
            FromJson(json);
        }
    }
}
