using IGX.Geometry.Common;
using IGX.Geometry.ConvexHull;
using IGX.Geometry.DataStructure; // 기하학적 데이터 구조 포함
using IGX.Geometry.DataStructure.IgxMesh;
using IGX.Geometry.DataStructure.MeshDecomposer;
using IGX.Geometry.GeometryBuilder;
using MathNet.Numerics.Distributions;
using OpenTK.Mathematics; // 기하학 객체 생성을 위한 빌더 패턴 포함

namespace IGX.Loader
{
    public static class Model3DQuery
    {
        public static Dictionary<string, (int partid, int ebomid, List<int> geometryIDs)> GetUniquePartList(Model3D modeldata)
        {
            Dictionary<string, (int partid, int ebomid, List<int> geometryIDs)> ebomIDs = [];
            int partid = 0;

            foreach (PrimitiveBase g in modeldata.Geometries.Values)
            {
                int eAssemblyID = g.InstanceData.EassemblyID;
                int geometryID = g.InstanceData.GeometryID;
                if (!modeldata.Eassemblies.TryGetValue(eAssemblyID, out IAssembly? assembly)) continue;

                string partName = assembly.Name;
                if (!ebomIDs.TryGetValue(partName, out (int, int, List<int>) existingpart))
                {
                    List<int> geos = [geometryID];
                    ebomIDs[partName] = (partid++, eAssemblyID, geos);
                }
                else
                {
                    ebomIDs[partName].geometryIDs.Add(geometryID);
                }
            }
            return ebomIDs;
        }


        // 기존의 Get 메서드들은 그대로 유지
        public static Vector4 GetGeometryColor(Model3D modelData, int geometryId) => modelData.Geometries.TryGetValue(geometryId, out var primitive) ? primitive.InstanceData.Color : default;
        public static GeometryInstance? GetMeshInstance(Model3D modelData, int geometryId) => modelData.Geometries.TryGetValue(geometryId, out var primitive) ? primitive.InstanceData : null;
        public static OOBB3 GetGeometryOOBB(Model3D modelData, int geometryId) => modelData.Geometries.TryGetValue(geometryId, out var primitive) ? primitive.Oobb : OOBB3.Empty;
        public static AABB3 GetGeometryAABB(Model3D modelData, int geometryId) => modelData.Geometries.TryGetValue(geometryId, out var primitive) ? primitive.Aabb : AABB3.Empty;
        public static int GetAssemblyIndex(Model3D modelData, int geometryId) => modelData.Geometries.TryGetValue(geometryId, out var primitive) ? primitive.InstanceData.EassemblyID : -1;
        public static ParaPrimType GetPrimitiveType(Model3D modelData, int geometryId) => modelData.Geometries.TryGetValue(geometryId, out var primitive) ? primitive.GeometryType : default;
        public static string? GetGrandPrimitiveType(Model3D modelData, int geometryId) => modelData.Geometries.TryGetValue(geometryId, out var primitive) ? primitive.GrandPrimType : null;
        public static float Thickness(Model3D modelData, int geometryID) => modelData.GetIgxMesh(geometryID)?.Thickness ?? -1;
        //public static int V0id(Model3D modelData, int geometryID, int edgeID) => modelData.GetIgxMesh(geometryID)?.V0id(edgeID) ?? -1;
        //public static int V1id(Model3D modelData, int geometryID, int edgeID) => modelData.GetIgxMesh(geometryID)?.V1id(edgeID) ?? -1;
        //public static int V0id(Model3D modelData, int geometryID, MeshAdjacency edge) => modelData.GetIgxMesh(geometryID)?.V0id(edge) ?? -1;
        //public static int V1id(Model3D modelData, int geometryID, MeshAdjacency edge) => modelData.GetIgxMesh(geometryID)?.V1id(edge) ?? -1;
        //public static Vertex Vertex0(Model3D modelData, int geometryID, int edgeID) => modelData.GetIgxMesh(geometryID)?.Vertex0(edgeID) ?? new Vertex();
        //public static Vertex Vertex0(Model3D modelData, int geometryID, int edgeID) => modelData.GetIgxMesh(geometryID)?.Vertex0(edgeID) ?? new Vertex();
        //public static Vertex Vertex0(Model3D modelData, int geometryID, MeshAdjacency edge) => modelData.GetIgxMesh(geometryID)?.Vertex0(edge) ?? new Vertex();
        //public static Vertex Vertex0(Model3D modelData, int geometryID, MeshAdjacency edge) => modelData.GetIgxMesh(geometryID)?.Vertex0(edge) ?? new Vertex();
        //public static List<int> TriangleIndices(Model3D modelData, int geometryID, TrianglesAdjacency triangleProperty) => modelData.GetIgxMesh(geometryID)?.TriangleIndices(triangleProperty) ?? [];
        //public static int[] TriangleIndices(Model3D modelData, int geometryID, int triangleID) => modelData.GetIgxMesh(geometryID)?.TriangleIndices(triangleID) ?? new int[0];
        //public static Vertex[] TriangleVertices(Model3D modelData, int geometryID, TrianglesAdjacency triangleProperty) => modelData.GetIgxMesh(geometryID)?.TriangleVertices(triangleProperty) ?? new Vertex[0];
        //public static Vertex[] TriangleVertices(Model3D modelData, int geometryID, int triangleID) => modelData.GetIgxMesh(geometryID)?.TriangleVertices(triangleID) ?? new Vertex[0];
        //public static List<int> SurfaceTriangles(Model3D modelData, int geometryID, int surfaceID) => modelData.GetIgxMesh(geometryID)?.SurfaceTriangleIDs(surfaceID) ?? [];
        //public static List<int> SurfaceIndices(Model3D modelData, int geometryID, int surfaceID) => modelData.GetIgxMesh(geometryID)?.SurfaceIndices(surfaceID) ?? [];
        //public static List<Vertex> SurfaceVertices(Model3D modelData, int geometryID, SurfaceMesh surface) => modelData.GetIgxMesh(geometryID)?.SurfaceVertices(surface) ?? [];
        //public static List<List<int>> GetBoundaryLoopsIndices(Model3D modelData, int geometryID, SurfaceMesh surface) => modelData.GetIgxMesh(geometryID)?.SurfaceBoundaryIndices(surface) ?? [];
        //public static List<List<Vertex>> GetBoundaryLoopsVertices(Model3D modelData, int geometryID, SurfaceMesh surface) => modelData.GetIgxMesh(geometryID)?.SurfaceBoundaryVerticesLists(surface) ?? [];
        //public static List<List<int>> GetBoundaryVerticesIndicesOfSurface(Model3D modelData, int geometryID, SurfaceMesh surface) => modelData.GetIgxMesh(geometryID)?.SurfaceBoundaryIndices(surface) ?? [];
        //public static List<int> GetOutBoundaryVerticesIndicesOfSurfrace(Model3D modelData, int geometryID, SurfaceMesh surface) => modelData.GetIgxMesh(geometryID)?.SurfaceOutBoundaryIndices(surface) ?? [];
        public static (List<Vector3> pos, List<Vector3> nor, List<uint> ind) MeshData(Model3D modelData, int geometryID)
        {
            var mesh = modelData.GetIgxMesh(geometryID);
            return (mesh?.Positions ?? [], mesh?.Normals ?? [], mesh?.Indices ?? []);
        }
        //public static List<int> EdgeIndices(Model3D modelData, int geometryID, MeshAdjacency edge) => modelData.GetIgxMesh(geometryID)?.EdgeIndices(edge) ?? [];
        //public static List<Vertex> EdgeVertices(Model3D modelData, int geometryID, MeshAdjacency edge) => modelData.GetIgxMesh(geometryID)?.EdgeVertices(edge) ?? [];
        public static SurfaceMesh? MoldSurface(Model3D modelData, int geometryID) => modelData.GetIgxMesh(geometryID)?.MoldSurface;
        public static SurfaceMesh? OffsetSurface(Model3D modelData, int geometryID) => modelData.GetIgxMesh(geometryID)?.OffsetSurface;

        public static List<int> GetGeometryIdsInAssemblyTree(Model3D modelData, int assemblyId)
        {
            HashSet<int> collectedGeometryIds = [];
            CollectGeometriesRecursive(modelData, assemblyId, collectedGeometryIds);
            return collectedGeometryIds.ToList();
        }

        private static void CollectGeometriesRecursive(Model3D modelData, int currentAssyId, HashSet<int> collectedGeometryIds)
        {
            if (!modelData.Eassemblies.TryGetValue(currentAssyId, out IAssembly? currentAssembly))
            {
                return;
            }
            if (currentAssembly.GeometryIDs?.Count > 0)
            {
                collectedGeometryIds.UnionWith(currentAssembly.GeometryIDs);
            }
            if (currentAssembly.SubEbom?.Count > 0)
            {
                foreach (int childAssyId in currentAssembly.SubEbom)
                {
                    CollectGeometriesRecursive(modelData, childAssyId, collectedGeometryIds);
                }
            }
        }

        public static List<int> FindSiblingAssemblyIds(Model3D modelData, int assemblyId)
        {
            if (!modelData.Eassemblies.TryGetValue(assemblyId, out IAssembly? targetAssy))
            {
                return [];
            }

            int? parentId = targetAssy.ParentBomID;
            if (parentId == -1) // 최상위 어셈블리인 경우
            {
                return [];
            }

            return modelData.Eassemblies
                .Where(entry => entry.Value.ParentBomID == parentId && entry.Key != assemblyId)
                .Select(entry => entry.Key)
                .ToList();
        }

        public static List<int> FindChildAssemblyIds(Model3D modelData, int assemblyId)
        {
            return modelData.Eassemblies
                .Where(entry => entry.Value.ParentBomID == assemblyId)
                .Select(entry => entry.Key)
                .ToList();
        }

        public static List<int> GetLeafAssemblyIds(Model3D modelData)
        {
            return modelData.Eassemblies
                .Where(entry => entry.Value.SubEbom == null || entry.Value.SubEbom.Count == 0)
                .Select(entry => entry.Key)
                .ToList();
        }

        public static List<int> GetAllUniqueGeometryIds(Model3D modelData)
        {
            return modelData.Eassemblies.Values
                .Where(assembly => assembly.GeometryIDs != null)
                .SelectMany(assembly => assembly.GeometryIDs)
                .Distinct()
                .ToList();
        }



        /// <summary>
        /// AABB를 자식 노드에서 부모 노드로 재귀적으로 전파.
        /// </summary>
        private static AABB3 PropagateAABBRecursive(Model3D modelData, IAssembly assembly)
        {
            AABB3 currentAabb = assembly.AssemblyAABB;
            if (assembly.SubEbom != null)
            {
                foreach (int childId in assembly.SubEbom)
                {
                    if (modelData.Eassemblies.TryGetValue(childId, out IAssembly? childAssembly))
                    {
                        currentAabb.Contain(PropagateAABBRecursive(modelData, childAssembly));
                    }
                }
            }
            assembly.AssemblyAABB = currentAabb;
            return currentAabb;
        }

        private static void CollectGeometriesRecursive(
            Model3D modelData,
            int currentAssyId,
            HashSet<int> collectedGeometryIds,
            HashSet<int> visitedAssemblyIds)
        {
            if (!visitedAssemblyIds.Add(currentAssyId))
            {
                return;
            }

            if (!modelData.Eassemblies.TryGetValue(currentAssyId, out IAssembly? currentAssembly))
            {
                return;
            }

            if (currentAssembly.GeometryIDs?.Count > 0)
            {
                collectedGeometryIds.UnionWith(currentAssembly.GeometryIDs);
            }

            if (currentAssembly.SubEbom?.Count > 0)
            {
                foreach (int childAssyId in currentAssembly.SubEbom)
                {
                    CollectGeometriesRecursive(modelData, childAssyId, collectedGeometryIds, visitedAssemblyIds);
                }
            }
        }
    }
}