using IGX.ViewControl.Buffer;
using IGX.ViewControl.Buffer.Common;
using IGX.ViewControl.Render;
using OpenTK.GLControl;
using OpenTK.Graphics.OpenGL4;
using System;
using System.Diagnostics;

namespace IGX.ViewControl
{
    /// <summary>
    /// G-Buffer 렌더링 패스: 장면의 기하학적 정보(위치, 법선, 색상 등)를 G-Buffer에 기록.
    /// </summary>
    public class GBufferPass : IRenderer, IDisposable
    {
        private readonly IgxViewAPI _apis;
        private Shader? _gBufferShader;
        public FrameBuffer? Gbuffer { get; private set; }
        private bool _isDisposed;
        private readonly object _disposeLock = new object();

        public GBufferPass(IgxViewAPI apis)
        {
            _apis = apis;
            //_glControl = glControl;
        }

        public void Initialize(int width, int height)
        {
            try
            {
                //_glControl.MakeCurrent();
                _gBufferShader = new Shader(ShaderSource.gBufferVtx, ShaderSource.gBufferFrg, false);
                Gbuffer = new FrameBuffer();
                Resize(width, height);
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"ErrorCheck initializing GBufferPass: {ex.Message}");
                Dispose();
                throw;
            }
        }

        public void Draw(IMyCamera camera, bool draw)
        {
            // 개선: Dispose 상태를 먼저 검사하여 불필요한 null 검사를 방지
            if (_isDisposed) return;
            if (Gbuffer == null || _gBufferShader == null) return;

            //_glControl.MakeCurrent();

            GL.Enable(EnableCap.DepthTest);
            GL.DepthFunc(DepthFunction.Less);
            GL.DepthMask(true);
            GL.Enable(EnableCap.CullFace);
            GL.CullFace(TriangleFace.Back);
            GL.Disable(EnableCap.Blend);

            Gbuffer.Use();
            GLState.ClearDrawingBuffer();

            using (_gBufferShader.Use())
            {
                _gBufferShader.SetUniformIfExist("uView", camera.ViewMatrix);
                _gBufferShader.SetUniformIfExist("uProjection", camera.ProjectionMatrix);
                _gBufferShader.SetUniformIfExist("shadeMode", (int)_apis.Shading.Mode);
                _apis.RenderManager.RenderAllModels(_gBufferShader);
            }

            GL.DepthMask(false);
            GL.Disable(EnableCap.DepthTest);
            GL.Disable(EnableCap.CullFace);
            GL.Enable(EnableCap.Blend);
        }

        public void Resize(int width, int height)
        {
            if (_isDisposed || Gbuffer == null) return;
            //_glControl.MakeCurrent();

            try
            {
                Gbuffer.UpdateGbuffer(width, height, _apis.Shading.Mode == ShadeMode.Xray);
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"ErrorCheck resizing GBufferPass: {ex.Message}");
                Dispose();
                throw;
            }
        }

        /// <summary>
        /// G-BufferPass가 소유한 리소스를 정리.
        /// </summary>
        public void Dispose()
        {
            lock (_disposeLock)
            {
                if (_isDisposed)
                {
                    return;
                }

                //_glControl.MakeCurrent();
                _gBufferShader?.Dispose();
                Gbuffer?.Dispose();

                _gBufferShader = null;
                Gbuffer = null;

                _isDisposed = true;
            }
        }
    }
}