using IGX.Geometry.Common;
using IGX.Geometry.DataStructure;
using OpenTK.Mathematics;

namespace IGX.ViewControl.Render.Materials
{
    public readonly struct VectorInstance
    {
        public Vertex Vtx { get; }
        public Vector4 Color { get; }
        public VectorInstance(Vertex v, Vector4 color)
        {
            Vtx = v;
            Color = color;
        }
    }
    public static class Vector2MatrixInstanceHelper
    {
        public static MatColInstance[] ConvertVectorToMatrix(IEnumerable<VectorInstance> arrowDataList, Matrix4 view, Matrix4 projection, int screenWidth, float size)
        {
            if (arrowDataList == null || !arrowDataList.Any())
                return Array.Empty<MatColInstance>();

            var instanceData = new MatColInstance[arrowDataList.Count()];
            int i = 0;
            foreach (var arrowData in arrowDataList)
            {
                Vector4 worldPos = new(arrowData.Vtx.Position, 1.0f);
                Vector4 clipPos = worldPos * view * projection;

                float scaleFactor = size * clipPos.W / projection.M11;

                Quaternion rotation = Vector3.UnitZ.FromUnitVectors(arrowData.Vtx.Normal.Normalized());

                Matrix4 model = Matrix4.CreateScale(scaleFactor) * Matrix4.CreateFromQuaternion(rotation) * Matrix4.CreateTranslation(arrowData.Vtx.Position);

                instanceData[i++] = new MatColInstance
                {
                    Model = model,
                    Color = arrowData.Color
                };
            }
            return instanceData;
        }
    }
}