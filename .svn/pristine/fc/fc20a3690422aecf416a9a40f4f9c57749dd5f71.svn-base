using OpenTK.Mathematics;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading.Tasks;

namespace IGX.ViewControl.Buffer.Common
{
    public static class Std140Helper
    {
        public static int GetAlignedSize<T>() where T : struct
        {
            var type = typeof(T);
            int currentOffset = 0;
            int maxAlignment = 1;

            foreach (var field in type.GetFields(BindingFlags.Instance | BindingFlags.Public))
            {
                int fieldSize = GetFieldSize(field.FieldType);
                int fieldAlignment = GetFieldAlignment(field.FieldType);

                // 현재 오프셋을 다음 멤버의 정렬 경계에 맞춤
                currentOffset = (currentOffset + fieldAlignment - 1) / fieldAlignment * fieldAlignment;

                currentOffset += fieldSize;
                maxAlignment = Math.Max(maxAlignment, fieldAlignment);
            }

            // 전체 구조체의 크기를 최대 정렬 경계에 맞춤
            return (currentOffset + maxAlignment - 1) / maxAlignment * maxAlignment;
        }

        private static int GetFieldSize(Type fieldType)
        {
            if (fieldType == typeof(Vector2) || fieldType == typeof(Vector3) || fieldType == typeof(Vector4))
            {
                return 4 * fieldType.GenericTypeArguments.Length; // float32 = 4 bytes
            }
            if (fieldType == typeof(Matrix4))
            {
                return 4 * 4 * 4; // 4x4 행렬 * 4바이트
            }
            // 그 외 기본 타입에 대한 크기 반환
            return Marshal.SizeOf(fieldType);
        }

        private static int GetFieldAlignment(Type fieldType)
        {
            if (fieldType == typeof(Vector2)) return 8;
            if (fieldType == typeof(Vector3) || fieldType == typeof(Vector4)) return 16;
            if (fieldType == typeof(Matrix4)) return 16;
            if (fieldType.IsArray) return 16; // 배열은 16바이트 경계
            // 그 외 기본 타입
            return Marshal.SizeOf(fieldType);
        }
    }

    public enum BufferLayout
    {
        Std140,
        Std430 // Std430도 이와 유사한 방식으로 구현 가능
    }
}
